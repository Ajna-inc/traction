name: Deploy
on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Target environment/namespace for deployment: dev, test, prod, tools'
        required: true
        default: 'dev'
      config:
        description: 'Configuration for deployment: dev, test, prod, pr'
        required: true
        default: 'dev'
jobs:

  deploy_manifest:
    name: Deploy Manifests
    runs-on: ubuntu-20.04
    
    steps:  
      - uses: actions/checkout@v2  

      - name: Check out manifest repo
        uses: actions/checkout@v2
        with:
          ssh-key: ${{ secrets.MANIFEST_REPO_DEPLOY_KEY }}
          repository:  ${{ secrets.MANIFEST_REPO }}
          path: gitops

      - name: Authenticate and set context
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          certificate_authority_data: ${{ secrets.OPENSHIFT_CA_CRT }}
          namespace: bc0192-${{ github.event.inputs.namespace }}
      
      - name: Run Helm Charts
        shell: bash
        run: |
          cd ./gitops
          helm upgrade -f ./charts/traction/values.yaml -f ./charts/traction/values-${{ github.event.inputs.config }}.yaml bc0192-traction-${{ github.event.inputs.config }} ./charts/traction --install --wait    
